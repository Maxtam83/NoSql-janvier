<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Météo CRUD</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 150px; overflow-y: auto; font-size: 0.85em; }
        .action-btn { margin-right: 5px; }
    </style>
</head>
<body class="container py-4">
    <h1 class="mb-4 text-center">Gestion des Données Météo (NoSQL)</h1>

    <!-- Configuration -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">Configuration</div>
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-10">
                    <label for="collectionName" class="form-label">Nom de la Collection MongoDB</label>
                    <input type="text" class="form-control" id="collectionName" value="current_weather_clean">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="loadData()">Charger</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulaire Ajout/Edition -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-success text-white" id="formHeader">Ajouter une nouvelle entrée</div>
        <div class="card-body">
            <input type="hidden" id="editId">
            <div class="mb-3">
                <label for="jsonData" class="form-label">Données (Format JSON)</label>
                <textarea class="form-control font-monospace" id="jsonData" rows="5" placeholder='{
  "time": "2026-01-15 0",
  "last_update": "2026-01-15 09:10",
  "lat": 48.880863,
  "lon": 2.348943,
  "temperature": 9.200012,
  "windspeed": 2.85,
  "zenithangle": 80.62777
}'></textarea>
                <div class="form-text">Saisissez un objet JSON valide. L'API accepte n'importe quelle structure (schemaless).</div>
            </div>
            <button class="btn btn-success" id="btnSave" onclick="saveData()">Ajouter</button>
            <button class="btn btn-secondary" onclick="resetForm()">Annuler / Reset</button>
        </div>
    </div>

    <!-- Liste des données -->
    <div class="card shadow-sm">
        <div class="card-header">Données existantes</div>
        <div class="card-body">
            <div id="alertContainer"></div>
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 20%">ID</th>
                            <th style="width: 60%">Contenu du Document</th>
                            <th style="width: 20%">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <!-- Les données seront insérées ici via JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "http://localhost:8000";

        // Charger les données au démarrage
        document.addEventListener('DOMContentLoaded', loadData);

        function getCollection() {
            return document.getElementById('collectionName').value || "current_weather_clean";
        }

        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            setTimeout(() => alertContainer.innerHTML = '', 4000);
        }

        async function loadData() {
            const collection = getCollection();
            try {
                const response = await fetch(`${API_URL}/weather_data?collection_name=${collection}`);
                if (!response.ok) throw new Error("Erreur réseau");
                const data = await response.json();
                renderTable(data);
            } catch (error) {
                console.error(error);
                showAlert("Impossible de charger les données. Vérifiez que l'API tourne sur le port 8000.", "danger");
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center">Aucune donnée trouvée dans cette collection.</td></tr>';
                return;
            }

            data.forEach(item => {
                const id = item._id;
                const displayItem = { ...item };
                delete displayItem._id; // On masque l'ID dans le JSON pour éviter la redondance

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><small class="text-muted">${id}</small></td>
                    <td><pre class="m-0">${JSON.stringify(displayItem, null, 2)}</pre></td>
                    <td>
                        <button class="btn btn-sm btn-warning action-btn" onclick='editItem(${JSON.stringify(item)})'>Éditer</button>
                        <button class="btn btn-sm btn-danger action-btn" onclick="deleteItem('${id}')">Suppr.</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function saveData() {
            const id = document.getElementById('editId').value;
            const jsonText = document.getElementById('jsonData').value;
            const collection = getCollection();
            
            let payload;
            try {
                payload = JSON.parse(jsonText);
            } catch (e) {
                alert("Le format JSON est invalide ! Vérifiez les guillemets et la syntaxe.");
                return;
            }
            delete payload._id; // Sécurité : on ne laisse pas l'utilisateur modifier l'ID manuellement dans le corps

            try {
                let url = `${API_URL}/weather_data`;
                let method = 'POST';

                if (id) {
                    url += `/${id}`;
                    method = 'PUT';
                }

                // Ajout du paramètre collection_name
                url += `?collection_name=${collection}`;

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error("Erreur API");
                
                showAlert(id ? "Mise à jour réussie" : "Ajout réussi");
                resetForm();
                loadData();
            } catch (error) {
                console.error(error);
                showAlert("Erreur lors de l'enregistrement", "danger");
            }
        }

        async function deleteItem(id) {
            if (!confirm("Êtes-vous sûr de vouloir supprimer cet élément ?")) return;
            
            const collection = getCollection();
            try {
                const response = await fetch(`${API_URL}/weather_data/${id}?collection_name=${collection}`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error("Erreur suppression");
                showAlert("Élément supprimé");
                loadData();
            } catch (error) {
                console.error(error);
                showAlert("Erreur lors de la suppression", "danger");
            }
        }

        function editItem(item) {
            document.getElementById('editId').value = item._id;
            const displayItem = { ...item };
            delete displayItem._id;
            
            document.getElementById('jsonData').value = JSON.stringify(displayItem, null, 4);
            
            // Changement visuel du formulaire
            const header = document.getElementById('formHeader');
            header.innerText = "Modifier l'entrée " + item._id;
            header.classList.replace('bg-success', 'bg-warning');
            header.classList.add('text-dark');
            header.classList.remove('text-white');
            
            const btn = document.getElementById('btnSave');
            btn.innerText = "Mettre à jour";
            btn.classList.replace('btn-success', 'btn-warning');
            
            window.scrollTo(0, 0);
        }

        function resetForm() {
            document.getElementById('editId').value = '';
            document.getElementById('jsonData').value = '';
            
            // Reset visuel
            const header = document.getElementById('formHeader');
            header.innerText = "Ajouter une nouvelle entrée";
            header.classList.replace('bg-warning', 'bg-success');
            header.classList.remove('text-dark');
            header.classList.add('text-white');

            const btn = document.getElementById('btnSave');
            btn.innerText = "Ajouter";
            btn.classList.replace('btn-warning', 'btn-success');
        }
    </script>
</body>
</html>